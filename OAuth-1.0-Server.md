# Index

* [Introduction](#introduction)
* OAuth flow
    * [Step 1: Obtaining a request token](#request-token)
    * [Step 2: Redirecting the user](#user-authentication)
    * [Step 3: Obtaining an access token](#access-token)
    * [Step 4 : Accessing to protected resources](#access-protected-resources)
* [Recommended OAuth 1.0 libraries](#lib)
* [Examples](#examples)
* [Signature](#signature)
* [Integration Example](#integration)

<span id="introduction"></span>
# Introduction

The following steps will explain how to connect to the [Open Bank project demo](https://openbankproject.com) OAuth Server 1.0. This authentication mechanism is necessary so a third party application can consume the Open Bank project API securely.    

The following documentation is based on the [OAuth 1.0 specification](http://tools.ietf.org/html/rfc5849) so if you need more details you can refer to it.  

Before starting to interact with the API, third party applications needs to get OAuth keys (consumer key and secret key). You can register your application [here](https://api.openbankproject.com/consumer-registration) to get those keys for interacting with real data. If you want to use the **sandbox** before handling real data, please register your application [here](https://apisandbox.openbankproject.com/consumer-registration) 

The **BASE-URL** alias in the following URLs must be replaced by __https://api.openbankproject.com__ or __https://apisandbox.openbankproject.com__ depending if you are accessing the real data or the sandbox.

<span id="wiki-request-token"></span>
## Step 1 : Obtaining a request token :
To start a sign in flow, the application must obtain a request token by sending a signed message to : 

_POST **BASE-URL**/oauth/initiate_ with the following parameters : 

* **oauth_callback**:  an absolute URI back to witch the server will redirect the resource owner (user) when Authorization step is completed. If the application is unable to receive callbacks the parameter value MUST be set to “oob” (case sensitive), to indicate an out-of-band configuration.

* **oauth_consumer_key** : The identifier portion of the client credentials (consumer key) which is obtained after application registration. 

* **oauth_nonce** : A nonce is a random string, uniquely generated by the client to allow the server to verify that a request has never been made before. The nonce value MUST be unique across all requests with the same timestamp, application credentials, and token combinations.

* **oauth_signature** : the result of signing the request. Explained in detail [here](https://github.com/OpenBankProject/OBP-API/wiki/OAuth-1.0-Server#signature-).

* **oauth_signature_method** : The name of the signature method that will be used by the application to sign the request, as defined in [OAuth protocol](http://tools.ietf.org/html/rfc5849#section-3.4). The Open Bank Project OAuth server support "SHA1" and "SHA256" so the parameter MUST be set to “HMAC-SHA1" or “HMAC-SHA256” 

* **oauth_timestamp** : The timestamp value MUST be a positive integer and is expressed in the number of seconds since January 1, 1970 00:00:00 GMT.

* **oauth_version** : OPTIONAL.  If present, MUST be set to "1.0".  Provides the version of the authentication process as defined in the [OAuth 1.0 protocol specification](http://tools.ietf.org/html/rfc5849).

**Example :**

POST /oauth/initiate HTTP/1.1 <br />
Host: demo.openbankproject.com <br />
Authorization: OAuth <br />
              oauth_callback="http%3A%2F%2Fprinter.example.com%2Fready",<br />
              oauth_consumer_key="cChZNFj6T5R0TigYB9yd1w",<br />
              oauth_nonce="ea9ec8429b68d6b77cd5600adbbb0456",<br />
              oauth_signature="F1Li3tvehgcraF8DMJ7OyxO4w9Y%3D",<br />
              oauth_signature_method="HMAC-SHA256",<br />
              oauth_timestamp="1318467427",<br />
              oauth_version="1.0"<br />

**important:** We will explain below in the "signature" section how to calculate the value of the "oauth_signature" field. 

**Note :**  line breaks are for display purposes only, the application MUST send the parameters on one line and the only separator between the parameters is a coma “,”.

The server validates the request and replies with a set of temporary credentials in the body of the HTTP response.

**Example** (line breaks are for display purposes only) :  

HTTP/1.1 200 OK <br />
     Content-Type: application/x-www-form-urlencoded <br /> 
     oauth_token=hh5s93j4hdidpola&oauth_token_secret=hdhd0244k9j7ao03&oauth_callback_confirmed=true<br />

The application should examine the HTTP status of the response. Any value other than 200 indicates 
a failure. The body of the response will contain the oauth_token, oauth_token_secret, 
and oauth_callback_confirmed parameters. The application should verify that oauth_callback_confirmed is true and store the other two values for the next steps.

<span id="user-authentication"></span>
# Step 2 : Redirecting the user: 
The next step is to direct the user to Open Bank Project so that he may complete the authentication. 
Direct the user to : _GET oauth/authorize_ and the request token obtained in step 1 should be passed as the oauth_token parameter.

The most seamless way for a website to implement this would be to issue a HTTP 302 redirect as the response to the original request. Mobile and desktop applications should open a new browser window or direct to the URL via an embedded web view.

**Example :** <br />
**BASE-URL**/oauth/authorize?oauth_token=NPcudxy0yU5T3tBzho7iCotZ3cnetKwcTIRlX0iwRl0

Upon a successful authentication, the callback URL would receive a request containing the oauth_token and oauth_verifier parameters. The application should verify that the token matches the request token received in step 1.

If the callback URL was not specified (oob) than the verifier will be shown in the page and the user has to enter it into the application manually.  

<span id="access-token"></span>
# Step 3 : Converting the request token to an access token

To convert the request token into a usable access token, the application must make a:   
_POST **BASE-URL**/oauth/token_ request containing the oauth_verifier value obtained in step 2. 
The request token is also passed as oauth_token parameter  of the **header**. 

**Note :** The oauth_callback_url parameter is not necessary any more.

**Example :** 

POST /oauth/token HTTP/1.1 <br />
Host: demo.openbankproject.com <br />
Authorization: OAuth <br />
              oauth_verifier="9312832",<br />
        oauth_token=”aze2342352aze”,<br />
              oauth_consumer_key="cChZNFj6T5R0TigYB9yd1w",<br />
              oauth_nonce="ea9ec8429b68d6b77cd5600adbbb0456",<br />
              oauth_signature="F1Li3tvehgcraF8DMJ7OyxO4w9Y%3D",<br />
              oauth_signature_method="HMAC-SHA256",<br />
              oauth_timestamp="1318467427",<br />
              oauth_version="1.0"<br />

Like the step 1, a successful response contains the oauth_token & oauth_token_secret and they should be stored and used for future authenticated requests to the OBP API. 

The application can know use the access token to access to protected resources. 

<span id="access-protected-resources"></span>
# Step 4 : Accessing to protected resources :

Once the application have an a access token and secret token, it can access to protected resources. The request is the same as in step 3 except the oauth_verifer which MUST not be included in the **header**.

Please see the API documentation for more details how to access protected resources. 

<span id="lib"></span>
# Recommended OAuth 1.0 libraries:
If you want to use a OAuth library to handle the OAuth process for your application, we have successfully tested these ones: 
* JAVA: 
   * [signpost](http://code.google.com/p/oauth-signpost/). **Warning** any version below 1.2.1.2 probably will not work. Version 1.2 which is the current Maven version seems to cause problems. 
* PHP: 
  * [OAuth Consumer And Server Library](https://code.google.com/p/oauth-php/)
* Scala: 
  * [Dispatch](http://dispatch.databinder.net/Dispatch.html)

<span id="examples"></span>
# Examples :
To show the OAuth integration in concrete examples, please check out these projects:  
[OAuth Example for NodeJS](https://github.com/OpenBankProject/Hello-OBP-OAuth1.0a-Node)

<span id="signature"></span>
# Signature :
According to the [section-3.4](http://tools.ietf.org/html/rfc5849#section-3.4) in the OAuth 1.0 protocol specification the signature computation is done following theses steps :

## a)  Signature Base String : 
The signature base string is a consistent, reproducible concatenation of several of the HTTP request elements into a single string.  The string is used as an input to the signature methods.

The signature base string includes the following components of the HTTP request:

* The HTTP request method (e.g., "GET", "POST", etc.).
* The authority as declared by the HTTP "Host" request **header** field.
* The path and query components of the request resource URI. 
* The protocol parameters excluding the "oauth_signature".
  
The signature base string does not cover the entire HTTP request. Most notably, it does not include the entity-body in most requests, nor does it include most HTTP **entity-headers**. 

The signature base string is constructed by concatenating together, in order, the following HTTP request elements: 

   1. The HTTP request method in uppercase.  For example: "HEAD", "GET", "POST", etc.  If the request uses a custom HTTP method, it MUST be encoded (Section 3.6). 
   2.  An "&" character (ASCII code 38). 
   3.  The base string URI from Section 3.4.1.2, after being encoded (Section 3.6). 
   4.  An "&" character (ASCII code 38). 
   5.  The request parameters as normalized in Section 3.4.1.3.2, after being encoded (Section 3.6).


Explained shortly below the example.
   
**Example:** 
     POST /oauth/token HTTP/1.1 <br />
     Host: demo.openbankproject.com <br /> 
     Content-Type: application/x-www-form-urlencoded <br /> 
     Authorization: OAuth <br />
                    oauth_consumer_key="91919", <br /> 
                    oauth_token="OGESD9MrWQEGPXOyPjHCRrCw7BPelWJjnomibV6bePU", <br />
                    oauth_signature_method="HMAC-SHA256", <br />
                    oauth_timestamp="1340878170", <br />
                    oauth_nonce="DFXOQFZVK8K46KDR11", <br />
                    oauth_signature="bYT5CMsGcbgUdFHObYMEfcx6bsw%3D"<br />

Is represented by the following signature base string (line breaks are for display purposes only): 

POST&https%3A%2F%2Fdemo.openbankproject.com&oauth_consumer_key%3D91919%26oauth_nonce%3DDFXOQFZVK8K46KDR11%26oauth_signature_method%3Dhmac-sha256%26oauth_timestamp%3D1340878170%26oauth_token%3DOGESD9MrWQEGPXOyPjHCRrCw7BPelWJjnomibV6bePU%26oauth_verifier%3DT0dXUDBZR09LUVlGTU9NSlhIUUc%26oauth_version%3D1

**The request parameters normalization :** 

   1.  The name and value of each parameter are **encoded** [Section 3.6](http://tools.ietf.org/html/rfc5849#section-3.6). 
   2.  The parameters are sorted by name, using ascending byte value ordering.
   3.  The name of each parameter is concatenated to its corresponding value using an "=" character     (ASCII code 61) as a separator, even if the value is empty. 
   4.  The sorted name/value pairs are concatenated together into a single string by using an "&"   character (ASCII code 38) as separator.

## B)  Signing the request :

The Open Bank Project OAuth 1.0 implementation uses the “HMAC-SHA1” and “HMAC-SHA256” as signing methods. 
The key to sign the base string is the concatenation of the consumer secret and the token secret with the “&” character in the middle like this: oauth_consumer_secret&oauth_token_secret, in the first step the application does not have yet a token so it will be an empty string.  

The signature that results from the signature process MUST be encoded in base 64 also since the protocol requires encoding all the OAuth parameters.

<span id="integration"></span>
# Integration example with a bank bank-end :

The following link show an example on how the integration of the OAuth process would be with a bank bank-end: [https://github.com/OpenBankProject/OBP-API/wiki/OAuth-Integration-Example](https://github.com/OpenBankProject/OBP-API/wiki/OAuth-Integration-Example)